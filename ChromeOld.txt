#!/bin/bash

# === T·ª± c√†i Python venv v√† gdown ===
if [[ ! -d "$HOME/gdown-venv" ]]; then
    echo "üì¶ ƒêang t·∫°o venv Python v√† c√†i gdown + API Google..."
    python3 -m venv ~/gdown-venv
    source ~/gdown-venv/bin/activate
    pip install --no-cache-dir gdown google-api-python-client google-auth-httplib2 google-auth-oauthlib
else
    source ~/gdown-venv/bin/activate
    if ! command -v gdown &>/dev/null; then
        pip install --no-cache-dir gdown google-api-python-client google-auth-httplib2 google-auth-oauthlib
    fi
fi

# === C·∫•u h√¨nh Google Drive Folder ID ===
CHROME_DRIVE_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_DRIVE_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"

DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

# === Ch·ªçn tr√¨nh duy·ªát ===
echo "Ch·ªçn tr√¨nh duy·ªát mu·ªën c√†i:"
select browser in "Chrome" "Firefox" "Tho√°t"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_DRIVE_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_DRIVE_ID"; BTYPE="firefox"; break;;
        Tho√°t) echo "üö™ Tho√°t script."; exit 0;;
        *) echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!";;
    esac
done

# === L·∫•y danh s√°ch file t·ª´ Google Drive ===
echo "üì• ƒêang l·∫•y danh s√°ch file t·ª´ Google Drive..."
python3 <<EOF > file_list.txt
from googleapiclient.discovery import build
import os
from google.auth.credentials import AnonymousCredentials
service = build('drive', 'v3', credentials=AnonymousCredentials())
results = service.files().list(q=f"'{DRIVE_ID}' in parents and trashed=false", fields="files(id, name)").execute()
for f in results.get('files', []):
    print(f"{f['id']}|{f['name']}")
EOF

if [[ ! -s file_list.txt ]]; then
    echo "‚ùå Kh√¥ng t√¨m th·∫•y file h·ª£p l·ªá trong folder!"
    exit 1
fi

# Hi·ªÉn th·ªã danh s√°ch
echo "üîç Danh s√°ch file kh·∫£ d·ª•ng:"
nl -s". " <(cut -d'|' -f2 file_list.txt)

read -p "üëâ Nh·∫≠p s·ªë th·ª© t·ª± file mu·ªën t·∫£i: " choice
FILE_ID=$(sed -n "${choice}p" file_list.txt | cut -d'|' -f1)
FILE_NAME=$(sed -n "${choice}p" file_list.txt | cut -d'|' -f2)

echo "üì• ƒêang t·∫£i file: $FILE_NAME..."
gdown "https://drive.google.com/uc?id=$FILE_ID"

# === G·ª° b·∫£n m·∫∑c ƒë·ªãnh ===
echo "üóëÔ∏è G·ª° b·∫£n m·∫∑c ƒë·ªãnh..."
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
elif [[ $BTYPE == "firefox" ]]; then
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

# === C√†i ƒë·∫∑t v√† kh√≥a c·∫≠p nh·∫≠t ===
if [[ $BTYPE == "chrome" ]]; then
    echo "üöÄ ƒêang c√†i Chrome..."
    sudo dpkg -i "$FILE_NAME"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
elif [[ $BTYPE == "firefox" ]]; then
    echo "üöÄ ƒêang c√†i Firefox..."
    tar -xf "$FILE_NAME"
    sudo rm -rf /opt/firefox_custom
    sudo mv firefox /opt/firefox_custom
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    sudo mkdir -p /opt/firefox_custom/distribution
    cat <<EOF2 | sudo tee /opt/firefox_custom/distribution/policies.json >/dev/null
{
  "policies": {
    "AppAutoUpdate": false
  }
}
EOF2
fi

# === T·∫°o shortcut ===
echo "üé® T·∫°o shortcut..."
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF3 > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF3
else
    cat <<EOF3 > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF3
fi

# === Pin v√†o taskbar ===
if command -v gsettings &>/dev/null; then
    gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
    gsettings set org.gnome.shell favorite-apps "$(gsettings get org.gnome.shell favorite-apps | sed "s/]$/, 'browser_custom.desktop']/")"
else
    echo "‚ÑπÔ∏è Tr√™n Lubuntu (LXQt), h√£y nh·∫•p ph·∫£i bi·ªÉu t∆∞·ª£ng trong menu -> 'Pin to Panel'."
fi

echo "‚úÖ Ho√†n t·∫•t! $BTYPE ƒë√£ c√†i, kh√≥a update, t·∫°o shortcut, pin taskbar."
