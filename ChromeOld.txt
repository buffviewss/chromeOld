#!/bin/bash

# === Cấu hình: gán Folder ID cho Chrome và Firefox ===
CHROME_DRIVE_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_DRIVE_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"

DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

# Cài gdown nếu chưa có
if ! command -v gdown &>/dev/null; then
    sudo apt update
    sudo apt install -y python3-pip
    pip3 install gdown
fi

# Lựa chọn trình duyệt
echo "Chọn trình duyệt bạn muốn cài:"
select browser in "Chrome" "Firefox" "Thoát"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_DRIVE_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_DRIVE_ID"; BTYPE="firefox"; break;;
        Thoát) exit 0;;
        *) echo "Lựa chọn không hợp lệ!";;
    esac
done

# Tải file từ Google Drive
gdown --folder "https://drive.google.com/drive/folders/$DRIVE_ID" --no-cookies

# Liệt kê file .deb (chrome) hoặc .tar.*
echo "Các file khả dụng:"
ls *.deb 2>/dev/null || ls *.tar.* 2>/dev/null

read -p "Nhập tên file cần cài: " FILE_SELECT
[[ -f "$FILE_SELECT" ]] || { echo "File không tồn tại"; exit 1; }

# Gỡ bản mặc định
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
elif [[ $BTYPE == "firefox" ]]; then
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

# Cài và khóa cập nhật
if [[ $BTYPE == "chrome" ]]; then
    sudo dpkg -i "$FILE_SELECT"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
elif [[ $BTYPE == "firefox" ]]; then
    tar -xf "$FILE_SELECT"
    sudo mv firefox "/opt/firefox_custom"
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    # Tắt auto update trong config Firefox
    echo 'user_pref("app.update.auto", false); user_pref("app.update.enabled", false);' | sudo tee -a /opt/firefox_custom/browser/defaults/pref/lock-update.js >/dev/null
fi

# Tạo shortcut
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
elif [[ $BTYPE == "firefox" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
fi

# Pin vào dock/taskbar
gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
if command -v gsettings &>/dev/null; then
    gsettings set org.gnome.shell favorite-apps "$(gsettings get org.gnome.shell favorite-apps | sed "s/]$/, 'browser_custom.desktop']/")"
fi

echo "✅ Xong! Bạn có thể tìm ứng dụng trong menu và launch nó."
