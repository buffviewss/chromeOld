#!/bin/bash

# === Tự cài Python venv và gdown nếu chưa có ===
if [[ ! -d "$HOME/gdown-venv" ]]; then
    echo "📦 Đang tạo môi trường Python venv và cài gdown..."
    python3 -m venv ~/gdown-venv
    source ~/gdown-venv/bin/activate
    pip install --no-cache-dir gdown
else
    source ~/gdown-venv/bin/activate
    if ! command -v gdown &>/dev/null; then
        echo "📥 Cài lại gdown trong venv..."
        pip install --no-cache-dir gdown
    fi
fi

# === Cấu hình: Folder ID Google Drive ===
CHROME_DRIVE_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_DRIVE_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"

# === Tạo thư mục tải tạm ===
DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

# === Lựa chọn trình duyệt ===
echo "Chọn trình duyệt bạn muốn cài:"
select browser in "Chrome" "Firefox" "Thoát"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_DRIVE_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_DRIVE_ID"; BTYPE="firefox"; break;;
        Thoát) echo "🚪 Thoát."; exit 0;;
        *) echo "❌ Lựa chọn không hợp lệ!";;
    esac
done

# === Tải file từ Google Drive ===
echo "📥 Đang tải danh sách file $BTYPE từ Google Drive..."
gdown --folder "https://drive.google.com/drive/folders/$DRIVE_ID" --no-cookies

# === Liệt kê file và chọn ===
if [[ $BTYPE == "chrome" ]]; then
    FILE_LIST=$(ls *.deb 2>/dev/null)
else
    FILE_LIST=$(ls *.tar.* 2>/dev/null)
fi

if [[ -z "$FILE_LIST" ]]; then
    echo "❌ Không tìm thấy file hợp lệ!"
    exit 1
fi

echo "🔍 Các file khả dụng:"
echo "$FILE_LIST"

FILE_COUNT=$(echo "$FILE_LIST" | wc -l)
if [[ $FILE_COUNT -eq 1 ]]; then
    FILE_SELECT=$(echo "$FILE_LIST")
    echo "✅ Tự động chọn file: $FILE_SELECT"
else
    read -p "👉 Nhập tên file cần cài: " FILE_SELECT
    [[ -f "$FILE_SELECT" ]] || { echo "❌ File không tồn tại!"; exit 1; }
fi

# === Gỡ bản mặc định ===
echo "🗑️ Đang gỡ bản mặc định..."
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
elif [[ $BTYPE == "firefox" ]]; then
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

# === Cài đặt và khóa cập nhật ===
if [[ $BTYPE == "chrome" ]]; then
    echo "🚀 Đang cài Chrome..."
    sudo dpkg -i "$FILE_SELECT"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
elif [[ $BTYPE == "firefox" ]]; then
    echo "🚀 Đang cài Firefox..."
    tar -xf "$FILE_SELECT"
    sudo rm -rf /opt/firefox_custom
    sudo mv firefox "/opt/firefox_custom"
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    # Tạo file policies.json để khóa update
    sudo mkdir -p /opt/firefox_custom/distribution
    cat <<EOF | sudo tee /opt/firefox_custom/distribution/policies.json >/dev/null
{
  "policies": {
    "AppAutoUpdate": false
  }
}
EOF
fi

# === Tạo shortcut ===
echo "🎨 Đang tạo shortcut..."
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
elif [[ $BTYPE == "firefox" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
fi

# === Pin vào taskbar (Ubuntu GNOME) ===
if command -v gsettings &>/dev/null; then
    gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
    gsettings set org.gnome.shell favorite-apps "$(gsettings get org.gnome.shell favorite-apps | sed "s/]$/, 'browser_custom.desktop']/")"
else
    echo "ℹ️ Trên Lubuntu (LXQt), hãy nhấp chuột phải icon trong menu -> Pin to Panel."
fi

echo "✅ Hoàn tất! $BTYPE đã được cài, khóa cập nhật, tạo shortcut và pin taskbar."
