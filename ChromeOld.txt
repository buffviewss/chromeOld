#!/bin/bash

# === Tá»± cÃ i Python venv vÃ  gdown náº¿u chÆ°a cÃ³ ===
if [[ ! -d "$HOME/gdown-venv" ]]; then
    echo "ğŸ“¦ Äang táº¡o mÃ´i trÆ°á»ng Python venv vÃ  cÃ i gdown..."
    python3 -m venv ~/gdown-venv
    source ~/gdown-venv/bin/activate
    pip install --no-cache-dir gdown
else
    source ~/gdown-venv/bin/activate
    if ! command -v gdown &>/dev/null; then
        echo "ğŸ“¥ CÃ i láº¡i gdown trong venv..."
        pip install --no-cache-dir gdown
    fi
fi

# === Cáº¥u hÃ¬nh: Folder ID Google Drive ===
CHROME_DRIVE_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_DRIVE_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"

# === Táº¡o thÆ° má»¥c táº£i táº¡m ===
DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

# === Lá»±a chá»n trÃ¬nh duyá»‡t ===
echo "Chá»n trÃ¬nh duyá»‡t báº¡n muá»‘n cÃ i:"
select browser in "Chrome" "Firefox" "ThoÃ¡t"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_DRIVE_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_DRIVE_ID"; BTYPE="firefox"; break;;
        ThoÃ¡t) echo "ğŸšª ThoÃ¡t."; exit 0;;
        *) echo "âŒ Lá»±a chá»n khÃ´ng há»£p lá»‡!";;
    esac
done

# === Táº£i file tá»« Google Drive ===
echo "ğŸ“¥ Äang táº£i danh sÃ¡ch file $BTYPE tá»« Google Drive..."
gdown --folder "https://drive.google.com/drive/folders/$DRIVE_ID" --no-cookies

# === Liá»‡t kÃª file vÃ  chá»n ===
if [[ $BTYPE == "chrome" ]]; then
    FILE_LIST=$(ls *.deb 2>/dev/null)
else
    FILE_LIST=$(ls *.tar.* 2>/dev/null)
fi

if [[ -z "$FILE_LIST" ]]; then
    echo "âŒ KhÃ´ng tÃ¬m tháº¥y file há»£p lá»‡!"
    exit 1
fi

echo "ğŸ” CÃ¡c file kháº£ dá»¥ng:"
echo "$FILE_LIST"

FILE_COUNT=$(echo "$FILE_LIST" | wc -l)
if [[ $FILE_COUNT -eq 1 ]]; then
    FILE_SELECT=$(echo "$FILE_LIST")
    echo "âœ… Tá»± Ä‘á»™ng chá»n file: $FILE_SELECT"
else
    read -p "ğŸ‘‰ Nháº­p tÃªn file cáº§n cÃ i: " FILE_SELECT
    [[ -f "$FILE_SELECT" ]] || { echo "âŒ File khÃ´ng tá»“n táº¡i!"; exit 1; }
fi

# === Gá»¡ báº£n máº·c Ä‘á»‹nh ===
echo "ğŸ—‘ï¸ Äang gá»¡ báº£n máº·c Ä‘á»‹nh..."
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
elif [[ $BTYPE == "firefox" ]]; then
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

# === CÃ i Ä‘áº·t vÃ  khÃ³a cáº­p nháº­t ===
if [[ $BTYPE == "chrome" ]]; then
    echo "ğŸš€ Äang cÃ i Chrome..."
    sudo dpkg -i "$FILE_SELECT"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
elif [[ $BTYPE == "firefox" ]]; then
    echo "ğŸš€ Äang cÃ i Firefox..."
    tar -xf "$FILE_SELECT"
    sudo rm -rf /opt/firefox_custom
    sudo mv firefox "/opt/firefox_custom"
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    # Táº¡o file policies.json Ä‘á»ƒ khÃ³a update
    sudo mkdir -p /opt/firefox_custom/distribution
    cat <<EOF | sudo tee /opt/firefox_custom/distribution/policies.json >/dev/null
{
  "policies": {
    "AppAutoUpdate": false
  }
}
EOF
fi

# === Táº¡o shortcut ===
echo "ğŸ¨ Äang táº¡o shortcut..."
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
elif [[ $BTYPE == "firefox" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
fi

# === Pin vÃ o taskbar (Ubuntu GNOME) ===
if command -v gsettings &>/dev/null; then
    gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
    gsettings set org.gnome.shell favorite-apps "$(gsettings get org.gnome.shell favorite-apps | sed "s/]$/, 'browser_custom.desktop']/")"
else
    echo "â„¹ï¸ TrÃªn Lubuntu (LXQt), hÃ£y nháº¥p chuá»™t pháº£i icon trong menu -> Pin to Panel."
fi

echo "âœ… HoÃ n táº¥t! $BTYPE Ä‘Ã£ Ä‘Æ°á»£c cÃ i, khÃ³a cáº­p nháº­t, táº¡o shortcut vÃ  pin taskbar."
