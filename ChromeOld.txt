#!/bin/bash

# === T·ª± c√†i Python venv v√† gdown ===
if [[ ! -d "$HOME/gdown-venv" ]]; then
    echo "üì¶ ƒêang t·∫°o venv Python v√† c√†i gdown..."
    python3 -m venv ~/gdown-venv
fi

source ~/gdown-venv/bin/activate

# C√†i gdown trong venv (ƒë·∫£m b·∫£o lu√¥n c√≥)
pip install --no-cache-dir gdown

# === C·∫•u h√¨nh Google Drive Folder ID ===
CHROME_DRIVE_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_DRIVE_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"

DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

# === Ch·ªçn tr√¨nh duy·ªát ===
echo "Ch·ªçn tr√¨nh duy·ªát mu·ªën c√†i:"
select browser in "Chrome" "Firefox" "Tho√°t"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_DRIVE_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_DRIVE_ID"; BTYPE="firefox"; break;;
        Tho√°t) echo "üö™ Tho√°t script."; exit 0;;
        *) echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!";;
    esac
done

# === T·∫£i to√†n b·ªô folder t·ª´ Google Drive ===
echo "üì• ƒêang t·∫£i to√†n b·ªô folder $BTYPE t·ª´ Google Drive..."
gdown --folder "https://drive.google.com/drive/folders/$DRIVE_ID" --no-cookies

# === Li·ªát k√™ file t·∫£i v·ªÅ ===
echo "üîç Danh s√°ch file t·∫£i v·ªÅ:"
if [[ $BTYPE == "chrome" ]]; then
    FILE_LIST=$(find "$DOWNLOAD_DIR" -type f -name "*.deb")
else
    FILE_LIST=$(find "$DOWNLOAD_DIR" -type f -name "*.tar.*")
fi

if [[ -z "$FILE_LIST" ]]; then
    echo "‚ùå Kh√¥ng t√¨m th·∫•y file h·ª£p l·ªá!"
    exit 1
fi

# Hi·ªÉn th·ªã danh s√°ch ƒë·ªÉ ch·ªçn
echo "$FILE_LIST" | nl -s". "
read -p "üëâ Nh·∫≠p s·ªë th·ª© t·ª± file mu·ªën c√†i: " choice

FILE_SELECT=$(echo "$FILE_LIST" | sed -n "${choice}p")

if [[ ! -f "$FILE_SELECT" ]]; then
    echo "‚ùå File kh√¥ng t·ªìn t·∫°i!"
    exit 1
fi

echo "‚úÖ Ch·ªçn file: $FILE_SELECT"

# === X√≥a file kh√¥ng ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ ti·∫øt ki·ªám dung l∆∞·ª£ng ===
echo "üßπ D·ªçn d·∫πp file kh√¥ng d√πng..."
find "$DOWNLOAD_DIR" -type f ! -name "$(basename "$FILE_SELECT")" -delete

# === G·ª° b·∫£n m·∫∑c ƒë·ªãnh ===
echo "üóëÔ∏è G·ª° b·∫£n m·∫∑c ƒë·ªãnh..."
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
elif [[ $BTYPE == "firefox" ]]; then
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

# === C√†i ƒë·∫∑t v√† kh√≥a c·∫≠p nh·∫≠t ===
if [[ $BTYPE == "chrome" ]]; then
    echo "üöÄ ƒêang c√†i Chrome..."
    sudo dpkg -i "$FILE_SELECT"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
elif [[ $BTYPE == "firefox" ]]; then
    echo "üöÄ ƒêang c√†i Firefox..."
    tar -xf "$FILE_SELECT"
    sudo rm -rf /opt/firefox_custom
    sudo mv firefox /opt/firefox_custom
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    sudo mkdir -p /opt/firefox_custom/distribution
    cat <<EOF2 | sudo tee /opt/firefox_custom/distribution/policies.json >/dev/null
{
  "policies": {
    "AppAutoUpdate": false
  }
}
EOF2
fi

# === T·∫°o shortcut ===
echo "üé® T·∫°o shortcut..."
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF3 > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF3
else
    cat <<EOF3 > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF3
fi

# === Pin v√†o taskbar ===
if command -v gsettings &>/dev/null; then
    gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
    gsettings set org.gnome.shell favorite-apps "$(gsettings get org.gnome.shell favorite-apps | sed "s/]$/, 'browser_custom.desktop']/")"
else
    echo "‚ÑπÔ∏è Tr√™n Lubuntu (LXQt), h√£y nh·∫•p ph·∫£i bi·ªÉu t∆∞·ª£ng trong menu -> 'Pin to Panel'."
fi

echo "‚úÖ Ho√†n t·∫•t! $BTYPE ƒë√£ ƒë∆∞·ª£c c√†i, kh√≥a update, t·∫°o shortcut v√† pin taskbar."
