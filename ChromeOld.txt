#!/bin/bash

# === T·ª± c√†i Python venv v√† gdown n·∫øu ch∆∞a c√≥ ===
if [[ ! -d "$HOME/gdown-venv" ]]; then
    echo "üì¶ ƒêang t·∫°o m√¥i tr∆∞·ªùng Python venv v√† c√†i gdown..."
    python3 -m venv ~/gdown-venv
    source ~/gdown-venv/bin/activate
    pip install --no-cache-dir gdown
else
    source ~/gdown-venv/bin/activate
    if ! command -v gdown &>/dev/null; then
        echo "üì• C√†i l·∫°i gdown trong venv..."
        pip install --no-cache-dir gdown
    fi
fi



# === C·∫•u h√¨nh: g√°n Folder ID cho Chrome v√† Firefox ===
CHROME_DRIVE_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_DRIVE_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"

DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

# C√†i gdown n·∫øu ch∆∞a c√≥
if ! command -v gdown &>/dev/null; then
    sudo apt update
    sudo apt install -y python3-pip
    pip3 install gdown
fi

# L·ª±a ch·ªçn tr√¨nh duy·ªát
echo "Ch·ªçn tr√¨nh duy·ªát b·∫°n mu·ªën c√†i:"
select browser in "Chrome" "Firefox" "Tho√°t"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_DRIVE_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_DRIVE_ID"; BTYPE="firefox"; break;;
        Tho√°t) exit 0;;
        *) echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!";;
    esac
done

# T·∫£i file t·ª´ Google Drive
gdown --folder "https://drive.google.com/drive/folders/$DRIVE_ID" --no-cookies

# Li·ªát k√™ file .deb (chrome) ho·∫∑c .tar.*
echo "C√°c file kh·∫£ d·ª•ng:"
ls *.deb 2>/dev/null || ls *.tar.* 2>/dev/null

read -p "Nh·∫≠p t√™n file c·∫ßn c√†i: " FILE_SELECT
[[ -f "$FILE_SELECT" ]] || { echo "File kh√¥ng t·ªìn t·∫°i"; exit 1; }

# G·ª° b·∫£n m·∫∑c ƒë·ªãnh
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
elif [[ $BTYPE == "firefox" ]]; then
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

# C√†i v√† kh√≥a c·∫≠p nh·∫≠t
if [[ $BTYPE == "chrome" ]]; then
    sudo dpkg -i "$FILE_SELECT"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
elif [[ $BTYPE == "firefox" ]]; then
    tar -xf "$FILE_SELECT"
    sudo mv firefox "/opt/firefox_custom"
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    # T·∫Øt auto update trong config Firefox
    echo 'user_pref("app.update.auto", false); user_pref("app.update.enabled", false);' | sudo tee -a /opt/firefox_custom/browser/defaults/pref/lock-update.js >/dev/null
fi

# T·∫°o shortcut
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
elif [[ $BTYPE == "firefox" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
fi

# Pin v√†o dock/taskbar
gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
if command -v gsettings &>/dev/null; then
    gsettings set org.gnome.shell favorite-apps "$(gsettings get org.gnome.shell favorite-apps | sed "s/]$/, 'browser_custom.desktop']/")"
fi

echo "‚úÖ Xong! B·∫°n c√≥ th·ªÉ t√¨m ·ª©ng d·ª•ng trong menu v√† launch n√≥."
